#!/bin/bash

# ==== TÊN FILE LOG ====
LOG_IN="log_in.txt"
LOG_OUT="log_out.txt"
LOG_PROCESS="log_process.txt"
DIFF_OUTPUT="diff_result.txt"

# ==== CHỌN LOG FILE ====
choose_log_file() {
    echo ""
    echo "Chọn file log:"
    echo "1) log_in"
    echo "2) log_out"
    echo "3) log_process"
    read -p "Nhập số (1-3): " log_choice

    case "$log_choice" in
        1) echo "$LOG_IN" ;;
        2) echo "$LOG_OUT" ;;
        3) echo "$LOG_PROCESS" ;;
        *) echo "none" ;;
    esac
}

# ==== MENU CHÍNH ====
while true; do
    echo ""
    echo "===== MENU CHÍNH ====="
    echo "1) Đếm số dòng trong log"
    echo "2) Tìm kiếm tên file trong log"
    echo "3) So sánh tên file giữa log_in và log_process"
    echo "0) Thoát"
    echo "======================"
    read -p "Chọn một tùy chọn (0-3): " choice

    case "$choice" in
        1)
            log_file=$(choose_log_file)
            if [[ "$log_file" == "none" ]]; then
                echo ">> Lựa chọn không hợp lệ!"
            elif [[ ! -f "$log_file" ]]; then
                echo ">> File $log_file không tồn tại!"
            else
                echo ">> Số dòng trong $log_file: $(wc -l < "$log_file") dòng"
            fi
            ;;
        2)
            log_file=$(choose_log_file)
            if [[ "$log_file" == "none" || ! -f "$log_file" ]]; then
                echo ">> Lựa chọn không hợp lệ hoặc file không tồn tại!"
            else
                read -p "Nhập từ khóa cần tìm: " keyword
                echo ">> Các dòng chứa '$keyword' trong $log_file:"
                grep --color=always "$keyword" "$log_file" || echo ">> Không tìm thấy!"
            fi
            ;;
        3)
            echo ">> So sánh tên file giữa $LOG_IN và $LOG_PROCESS..."

            # Tách tên file từ từng log (bỏ giờ)
            awk '{print $2}' "$LOG_IN" | sort | uniq > /tmp/in_files.txt
            awk '{print $2}' "$LOG_PROCESS" | sed 's/processed-//' | sort | uniq > /tmp/process_files.txt

            # So sánh – những file có ở in nhưng không có ở process
            comm -23 /tmp/in_files.txt /tmp/process_files.txt > "$DIFF_OUTPUT"

            echo ">> Đã lưu các file KHÁC NHAU vào: $DIFF_OUTPUT"
            echo ">> Tổng số file khác biệt: $(wc -l < "$DIFF_OUTPUT")"
            ;;
        0)
            echo ">> Thoát chương trình. Tạm biệt!"
            exit 0
            ;;
        *)
            echo ">> Lựa chọn không hợp lệ. Vui lòng thử lại."
            ;;
    esac
done
