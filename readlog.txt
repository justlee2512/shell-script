#!/bin/bash

# ===== TH∆Ø M·ª§C CH·ª®A LOG NG√ÄY =====
BASE_DIR="/a/b/c/log"
selected_date=""
LOG_DIR=""
LOG_IN=""
LOG_OUT=""
LOG_PROCESS=""

# ===== CH·ªåN NG√ÄY LOG TR∆Ø·ªöC =====
choose_date() {
    echo ""
    echo "üîç ƒêang t√¨m c√°c th∆∞ m·ª•c log trong $BASE_DIR..."

    # T√¨m th∆∞ m·ª•c ƒë·ªãnh d·∫°ng yyyyddMM
    available_dates=($(find "$BASE_DIR" -maxdepth 1 -type d -printf "%f\n" | grep -E '^[0-9]{8}$' | sort -r | head -n 10))

    if [[ ${#available_dates[@]} -eq 0 ]]; then
        echo "‚ùå Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c ng√†y n√†o trong $BASE_DIR"
        exit 1
    fi

    echo "üóÇÔ∏è  C√°c ng√†y log g·∫ßn nh·∫•t:"
    for i in "${!available_dates[@]}"; do
        echo "$((i+1))) ${available_dates[$i]}"
    done

    read -p "üî¢ Ch·ªçn s·ªë t∆∞∆°ng ·ª©ng (1-${#available_dates[@]}): " day_choice

    if [[ "$day_choice" =~ ^[0-9]+$ ]] && (( day_choice >= 1 && day_choice <= ${#available_dates[@]} )); then
        selected_date="${available_dates[$((day_choice-1))]}"
        LOG_DIR="$BASE_DIR/$selected_date"
        LOG_IN="$LOG_DIR/log_in.txt"
        LOG_OUT="$LOG_DIR/log_out.txt"
        LOG_PROCESS="$LOG_DIR/log_process.txt"
        echo "‚úÖ ƒê√£ ch·ªçn th∆∞ m·ª•c log: $LOG_DIR"
    else
        echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá. Tho√°t ch∆∞∆°ng tr√¨nh."
        exit 1
    fi
}

# ===== CH·ªåN FILE LOG (THEO NG√ÄY ƒê√É CH·ªåN) =====
choose_log_file() {
    echo ""
    echo "Ch·ªçn file log:"
    echo "1) log_in"
    echo "2) log_out"
    echo "3) log_process"
    read -p "Nh·∫≠p s·ªë (1-3): " log_choice

    case "$log_choice" in
        1) echo "$LOG_IN" ;;
        2) echo "$LOG_OUT" ;;
        3) echo "$LOG_PROCESS" ;;
        *) echo "none" ;;
    esac
}

# ===== B·∫ÆT BU·ªòC CH·ªåN NG√ÄY TR∆Ø·ªöC =====
echo "===== CH·ªåN NG√ÄY LOG ====="
choose_date

# ===== V√íNG L·∫∂P MENU =====
while true; do
    echo ""
    echo "===== MENU CH√çNH ====="
    echo "1) ƒê·∫øm s·ªë d√≤ng trong log"
    echo "2) T√¨m ki·∫øm t√™n file trong log"
    echo "3) So s√°nh t√™n file gi·ªØa log_in v√† log_process"
    echo "0) Tho√°t"
    echo "======================"
    read -p "Ch·ªçn m·ªôt t√πy ch·ªçn (0-3): " choice

    case "$choice" in
        1)
            log_file=$(choose_log_file)
            if [[ "$log_file" == "none" || ! -f "$log_file" ]]; then
                echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá ho·∫∑c file kh√¥ng t·ªìn t·∫°i!"
            else
                echo "‚úÖ S·ªë d√≤ng trong $log_file: $(wc -l < "$log_file") d√≤ng"
            fi
            ;;
        2)
            log_file=$(choose_log_file)
            if [[ "$log_file" == "none" || ! -f "$log_file" ]]; then
                echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá ho·∫∑c file kh√¥ng t·ªìn t·∫°i!"
            else
                read -p "Nh·∫≠p t·ª´ kh√≥a c·∫ßn t√¨m: " keyword
                echo "üìÇ K·∫øt qu·∫£ t√¨m '$keyword' trong $log_file:"
                grep --color=always "$keyword" "$log_file" || echo "Kh√¥ng t√¨m th·∫•y."
            fi
            ;;
        3)
            if [[ ! -f "$LOG_IN" || ! -f "$LOG_PROCESS" ]]; then
                echo "‚ùå Thi·∫øu log_in.txt ho·∫∑c log_process.txt!"
                continue
            fi

            echo "üîç So s√°nh t√™n file gi·ªØa log_in v√† log_process..."

            awk '{print $2}' "$LOG_IN" | sort | uniq > /tmp/in_files.txt
            awk '{print $2}' "$LOG_PROCESS" | sed 's/^processed-//' | sort | uniq > /tmp/process_files.txt

            DIFF_OUTPUT="./diff_result_$selected_date.txt"
            comm -23 /tmp/in_files.txt /tmp/process_files.txt > "$DIFF_OUTPUT"

            echo "‚úÖ ƒê√£ l∆∞u file kh√°c bi·ªát: $DIFF_OUTPUT"
            echo "‚úÖ S·ªë file kh√°c nhau: $(wc -l < "$DIFF_OUTPUT")"
            ;;
        0)
            echo "üëã Tho√°t ch∆∞∆°ng tr√¨nh. H·∫πn g·∫∑p l·∫°i!"
            exit 0
            ;;
        *)
            echo "‚ö†Ô∏è L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i."
            ;;
    esac
done
