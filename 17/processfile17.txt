#!/bin/bash
# file_processing_pipeline.sh
# Author: ChatGPT - customized for your workflow

# ---------------------- CONFIG ----------------------
SOURCE_DIR="/Users/richard/Data/80/files/so_le"
NUM_PARTS=5        # Số subfolder/process song song, có thể tăng/giảm
DESTINATION_DIR="/Users/richard/Data/80/18/inwark-file"
PROCESSED_DIR="/Users/richard/Data/80/18/process-file"
OTHER_DIR="$PROCESSED_DIR/other"
HOSTNAME=$(hostname)

# ----------------------------------------------------
echo "Tạo các subfolder part1 ... part$NUM_PARTS"
for i in $(seq 1 $NUM_PARTS); do
    mkdir -p "$SOURCE_DIR/part$i"
done
mkdir -p "$DESTINATION_DIR"
mkdir -p "$PROCESSED_DIR"
mkdir -p "$OTHER_DIR"

# -------------- STEP 1: Chia file vào subfolder ---------------
echo "Chia file vào các subfolder..."

# Chỉ chia những file nằm ngoài subfolder (tránh chia lặp)
for file in "$SOURCE_DIR"/*; do
    [ -f "$file" ] || continue
    fname=$(basename "$file")
    # Dùng hash để chia đều, tránh lặp lại với cùng tên file
    hash=$(echo -n "$fname" | md5sum | cut -c1)
    part=$(( (0x$hash % NUM_PARTS) + 1 ))
    mv "$file" "$SOURCE_DIR/part$part/"
done

# -------------- STEP 2: Định nghĩa function xử lý file ---------------
process_subfolder() {
    part_dir="$1"
    for file in "$part_dir"/*; do
        [ -f "$file" ] || continue
        base_name=$(basename "$file")
        if [[ "$base_name" == ABC-DT*.csv ]]; then
            number=$(echo "$base_name" | grep -oE '[0-9]+')
            new_name="$PROCESSED_DIR/processed-ABC-DT${number}-${HOSTNAME}.csv"
            mv "$file" "$new_name"
            echo "[$(basename "$part_dir")] Đã đổi tên: $base_name -> $(basename "$new_name")"
        elif [[ "$base_name" == DT*.fin ]]; then
            number=$(echo "$base_name" | grep -oE '[0-9]+')
            new_name="$PROCESSED_DIR/processed-DT${number}.fin"
            mv "$file" "$new_name"
            echo "[$(basename "$part_dir")] Đã đổi tên: $base_name -> $(basename "$new_name")"
        else
            mv "$file" "$OTHER_DIR/"
            echo "[$(basename "$part_dir")] Đã chuyển $base_name vào thư mục other"
        fi
    done
}

export -f process_subfolder
export PROCESSED_DIR OTHER_DIR HOSTNAME

# -------------- STEP 3: Chạy song song các process xử lý subfolder ---------------
echo "Bắt đầu xử lý file song song..."

for i in $(seq 1 $NUM_PARTS); do
    part_path="$SOURCE_DIR/part$i"
    bash -c "process_subfolder \"$part_path\"" &
done

wait  # Chờ tất cả process xong

echo "Hoàn thành toàn bộ pipeline!"
